<!DOCTYPE html>
<html>

<head>
    <title>Weather APRS</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A==" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js" integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA==" crossorigin=""></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.0/dist/MarkerCluster.css" />

    <script src="https://unpkg.com/leaflet.markercluster@1.5.0/dist/leaflet.markercluster.js" crossorigin=""></script>
    <style>
        .weather-marker {
            color: black;
            border: 3px solid darkslategray;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-weight: bold;
            font-size: 14px;
            text-align: center;
            line-height: 30px;
        }
        
        .darkviolet {
            background-color: darkviolet;
        }
        
        .slateblue {
            background-color: slateblue;
        }
        
        .greenyellow {
            background-color: greenyellow;
        }
        
        .orange {
            background-color: orange;
        }
        
        .orangered {
            background-color: orangered;
        }
        
        .firebrick {
            background-color: firebrick;
        }
    </style>
</head>

<body>
    <div id="mapid" style="width: 100%; height: 800px"></div>
    <script>
        let map = L.map("mapid").setView([47, 27], 3);

        // add the OpenStreetMap tiles
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            maxZoom: 15,
            attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>',
        }).addTo(map);

        let markers = L.markerClusterGroup({
            maxClusterRadius: 50,
            disableClusteringAtZoom: 8
        });

        //--------------------------------------------------------------------------------------------------------------
        // Utility
        function tempToColor(temp) {
            if (temp < 0) return "darkviolet";
            else if (temp < 10) return "slateblue";
            else if (temp < 20) return "greenyellow";
            else if (temp < 30) return "orange";
            else if (temp < 40) return "orangered";
            else return "firebrick";
        }

        //--------------------------------------------------------------------------------------------------------------
        // API Calls
        const server = "127.0.0.1"
        const port = 9090
        let req = new XMLHttpRequest();
        console.log("Getting all stations");
        req.open("GET", `http://${server}:${port}/api/v0/stations/data`);
        req.send();

        req.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                const data = JSON.parse(this.responseText);
                console.log(data);
                const features = [];
                for (const s in data) {
                    const c = data[s].location.coordinates;
                    const w = data[s].weather.wx;
                    const temp = Math.round(w.temp);

                    const icon = L.divIcon({
                        iconSize: null,
                        className: "weather-marker " + tempToColor(temp),
                        html: temp,
                    });

                    const markerData = {
                        title: s,
                        weather: w,
                    };
                    const marker = L.marker(new L.LatLng(c[1], c[0]), {
                        icon: icon,
                        data: markerData,
                    });

                    markers.addLayer(marker);
                }
                map.addLayer(markers);
                markers.on("click", function(a) {
                    let stationName = a.layer.options.data.title;
                    let req = new XMLHttpRequest();
                    req.open("GET", `http://${server}:${port}/api/v0/station/${stationName}`);
                    req.send();

                    req.onreadystatechange = function() {
                        if (this.readyState == 4 && this.status == 200) {
                            try {
                                const data = JSON.parse(this.responseText);
                                console.log(data);
                                const wdate = new Date(data.weather.timestamp).toString();
                                const wx = data.weather.wx;
                                let html =
                                    "<b>Station " +
                                    stationName +
                                    "</b><br> " +
                                    wdate +
                                    " <br> Wind Gust: " +
                                    (wx.wind_gust || "None") +
                                    " <br> Wind Direction: " +
                                    (wx.wind_direction || "None") +
                                    " <br> Wind Speed: " +
                                    (wx.wind_speed || "None") +
                                    " <br> Temperature: " +
                                    wx.temp +
                                    " <br> Rain 24h " +
                                    (wx.rain_24h || "None") +
                                    " <br> Humidity " +
                                    wx.humidity +
                                    " <br> Pressure: " +
                                    wx.pressure;

                                let popup = L.popup().setLatLng(a.layer.getLatLng()).setContent(html).openOn(map);
                            } catch (e) {
                                console.log(e);
                            }
                        }
                    };
                });
            }
        };
    </script>
</body>

</html>